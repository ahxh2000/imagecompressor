<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>优雅图片压缩</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* 重置样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f6f9fc 0%, #f0f4f8 100%);
            color: #1d1d1f;
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            background: linear-gradient(120deg, #0071e3, #00a3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: clamp(32px, 5vw, 56px);
            letter-spacing: -1px;
            margin-bottom: 16px;
            padding: 0 10px;
        }

        .header p {
            font-size: clamp(14px, 3vw, 16px);
            padding: 0 20px;
        }

        .upload-area {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            padding: clamp(20px, 4vw, 40px);
            text-align: center;
            margin-bottom: clamp(20px, 4vw, 40px);
        }

        .upload-button {
            background: linear-gradient(135deg, #0071e3, #00a3ff);
            color: white;
            padding: clamp(12px, 2vw, 16px) clamp(20px, 4vw, 32px);
            border-radius: 20px;
            border: none;
            font-size: clamp(14px, 3vw, 16px);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: -0.2px;
            box-shadow: 0 8px 16px rgba(0, 113, 227, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 113, 227, 0.3);
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        .preview-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .preview-box h3 {
            margin-bottom: 16px;
            color: #1d1d1f;
        }

        .preview-image {
            max-width: 100%;
            height: auto;
            margin-bottom: 16px;
        }

        .file-info {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 16px;
        }

        .download-button {
            background: #34c759;
            color: white;
            padding: 8px 16px;
            border-radius: 16px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-button:hover {
            background: #30b753;
            transform: translateY(-1px);
        }

        .quality-control {
            margin: 20px 0;
            padding: 15px !important;
        }

        .quality-slider {
            width: 100%;
            max-width: 300px;
        }

        /* 新增图标样式 */
        .feature-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            fill: #0071e3;
        }
        
        .scenario-illustration {
            width: 100%;
            max-width: 200px;
            margin: 0 auto 20px;
        }

        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: #0071e3;
            color: white;
            margin-right: 12px;
            font-weight: 600;
        }

        .benefit-card {
            transition: transform 0.3s ease;
        }
        
        .benefit-card:hover {
            transform: translateY(-5px);
        }

        /* 批量上传样式 */
        .batch-controls {
            margin: 20px 0;
            display: none;
        }
        
        .drag-drop-area {
            border: 2px dashed rgba(0, 113, 227, 0.3);
            background: rgba(0, 113, 227, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .drag-drop-area.dragover {
            background: rgba(0, 113, 227, 0.08);
            border-color: #0071e3;
            transform: scale(1.01);
        }
        
        .file-list {
            max-height: none;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: clamp(12px, 2vw, 20px);
            margin: 20px 0;
        }
        
        .file-item {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .file-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.1);
        }
        
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 12px;
        }
        
        .comparison-side {
            position: relative;
        }
        
        .comparison-side h4 {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .preview-wrapper {
            position: relative;
            padding-top: 75%;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            cursor: zoom-in;
        }
        
        .preview-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .file-info-wrapper {
            padding: 12px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .size-info {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .compression-ratio {
            display: inline-block;
            padding: 2px 6px;
            background: #34c759;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .image-comparison-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 40px;
        }
        
        .modal-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-width: 1200px;
            margin: 10px;
            height: 100%;
            background: white;
            border-radius: 16px;
            padding: 16px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .modal-close:hover {
            background: #f5f5f7;
        }
        
        .comparison-wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .comparison-image {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comparison-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .batch-progress {
            height: 6px;
            background: rgba(0, 113, 227, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .batch-progress-bar {
            background: linear-gradient(90deg, #0071e3, #00a3ff);
            box-shadow: 0 0 10px rgba(0, 113, 227, 0.3);
        }

        /* 悬浮预览样式 */
        .hover-preview {
            display: none !important; /* 在移动端禁用悬浮预览 */
        }

        .hover-preview-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .hover-preview-side {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hover-preview-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .hover-preview-info {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* 添加动画效果 */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* 添加移动端特定样式 */
        @media (max-width: 768px) {
            /* 调整间距 */
            .container {
                margin: 10px auto;
            }

            /* 优化拖放区域 */
            .drag-drop-area {
                padding: 15px;
            }

            .drag-drop-area p {
                font-size: 14px;
            }

            /* 调整文件项布局 */
            .file-item {
                margin-bottom: 15px;
            }

            .comparison-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* 优化按钮触摸区域 */
            .upload-button,
            .download-button {
                min-height: 44px; /* 确保足够的触摸区域 */
            }

            /* 添加触摸反馈 */
            .file-item:active {
                transform: scale(0.98);
            }

            /* 优化滑块控件 */
            input[type="range"] {
                height: 30px; /* 增加触摸区域 */
            }

            /* 调整图标大小 */
            .ph {
                font-size: 20px;
            }

            /* 优化功能介绍区域 */
            .features-section {
                margin-top: 30px;
            }

            .feature-card {
                margin-bottom: 20px;
            }

            /* 调整文字大小 */
            h2 {
                font-size: 24px !important;
            }

            h3 {
                font-size: 18px !important;
            }

            p {
                font-size: 14px !important;
            }

            /* 优化进度条 */
            .batch-progress {
                height: 8px; /* 更容易看到 */
            }

            /* 添加下拉刷新提示 */
            .pull-to-refresh {
                text-align: center;
                padding: 10px;
                color: #666;
                font-size: 12px;
            }
        }

        /* 添加深色模式支持 */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                color: #ffffff;
            }

            .upload-area,
            .file-item,
            .preview-box {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
            }

            .drag-drop-area {
                border-color: rgba(255, 255, 255, 0.2);
                background: rgba(255, 255, 255, 0.05);
            }

            .file-info-wrapper {
                background: rgba(0, 0, 0, 0.2);
            }

            .size-info {
                color: #999;
            }
        }

        /* 添加平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 0 30px;
            }

            .file-list {
                grid-template-columns: repeat(2, 1fr);
            }

            .feature-card > div {
                flex-direction: row !important;
            }
        }

        /* 添加动画优化 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* 功能卡片响应式布局 */
        .feature-card {
            padding: clamp(20px, 4vw, 40px);
            margin-bottom: clamp(20px, 4vw, 40px);
        }

        .feature-card > div {
            display: flex;
            align-items: center;
            gap: clamp(20px, 4vw, 40px);
        }

        .feature-content {
            flex: 1;
        }

        .feature-illustration {
            width: clamp(200px, 30vw, 300px);
        }

        /* 应用场景网格响应式 */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: clamp(16px, 3vw, 24px);
        }

        /* 步骤说明响应式 */
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: clamp(16px, 3vw, 24px);
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .feature-card > div {
                flex-direction: column;
            }

            .feature-card h2 {
                font-size: 24px !important;
                text-align: center;
            }

            .feature-illustration {
                width: 100%;
                max-width: 250px;
                margin: 0 auto;
            }

            .feature-content {
                text-align: center;
            }

            .feature-icon-wrapper {
                margin: 0 auto 16px;
            }

            /* 调整格式标签布局 */
            .format-tags {
                justify-content: center;
                flex-wrap: wrap;
            }

            /* 优化步骤说明 */
            .step-item {
                padding: clamp(16px, 4vw, 24px);
            }

            .step-number {
                position: static;
                margin: 0 auto 16px;
            }

            /* 调整应用场景卡片 */
            .scenario-card {
                padding: clamp(16px, 4vw, 24px);
            }
        }

        /* 平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .feature-card > div {
                gap: 24px;
            }

            .feature-illustration {
                width: 40%;
            }
        }

        /* 动画优化 */
        @media (prefers-reduced-motion: reduce) {
            .feature-card,
            .scenario-card,
            .step-item {
                transition: none !important;
            }
        }

        /* 功能介绍区域的基础样式 */
        .features-section {
            margin-top: 60px;
            padding: 20px;
        }

        .features-section h2.section-title {
            text-align: center;
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 600;
            margin-bottom: 40px;
            background: linear-gradient(120deg, #0071e3, #00a3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 功能卡片统一样式 */
        .feature-card {
            background: white;
            border-radius: 24px;
            padding: clamp(24px, 4vw, 40px);
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .feature-content {
            display: flex;
            align-items: flex-start;
            gap: 40px;
        }

        /* 图标容器统一样式 */
        .feature-icon-container {
            width: 60px;
            height: 60px;
            min-width: 60px;
            background: linear-gradient(135deg, #0071e3, #00a3ff);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-icon-container i {
            font-size: 28px;
            color: white;
        }

        /* 文本内容统一样式 */
        .feature-text {
            flex: 1;
        }

        .feature-text h3 {
            font-size: clamp(20px, 3vw, 24px);
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .feature-text p {
            font-size: clamp(14px, 2vw, 16px);
            color: #666;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        /* 应用场景卡片网格 */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 40px 0;
        }

        .scenario-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
        }

        .scenario-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #0071e3, #00a3ff);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .scenario-icon i {
            font-size: 24px;
            color: white;
        }

        /* 使用步骤样式 */
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin: 40px 0;
        }

        .step-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .step-number {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 32px;
            height: 32px;
            background: #0071e3;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #0071e3, #00a3ff);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .step-icon i {
            font-size: 32px;
            color: white;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .feature-content {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 20px;
            }

            .steps-grid {
                grid-template-columns: 1fr;
            }

            .step-card {
                padding: 24px;
            }

            .feature-icon-container {
                margin: 0 auto;
            }
        }

        /* 平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .steps-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }

            .step-card {
                padding: 24px;
            }
        }
    </style>

    <!-- 添加移动端meta标签 -->
    <meta name="theme-color" content="#0071e3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>优雅图片压缩</h1>
            <p>简单、快速地压缩您的图片，保持清晰度的同时减小文件体积</p>
        </div>

        <!-- 工具区域移到最上方 -->
        <div class="upload-area">
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
            <button class="upload-button" onclick="document.getElementById('imageInput').click()">
                <i class="ph ph-upload-simple" style="margin-right: 8px;"></i>
                选择图片或拖拽至此
            </button>
            
            <div class="drag-drop-area" id="dragDropArea">
                <div style="text-align: center;">
                    <i class="ph ph-images" style="font-size: 48px; color: #0071e3; margin-bottom: 16px;"></i>
                    <p>将图片拖放到此处，或点击上方按钮选择</p>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">支持 JPG、PNG、WebP 格式，最多50张</p>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="batch-controls" id="batchControls">
                <div class="batch-progress">
                    <div class="batch-progress-bar" id="batchProgress"></div>
                </div>
                <button class="download-button" onclick="downloadAll()" id="downloadAllBtn" disabled>
                    打包下载全部（0/0）
                </button>
            </div>

            <div class="quality-control" style="background: rgba(0, 113, 227, 0.05); padding: 20px; border-radius: 12px; margin: 20px 0;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <label for="quality" style="font-weight: 500;">压缩质量</label>
                    <span id="qualityValue" style="font-weight: 600; color: #0071e3;">80%</span>
                </div>
                <input type="range" id="quality" class="quality-slider" min="1" max="100" value="80" 
                       style="width: 100%; height: 6px; -webkit-appearance: none; background: rgba(0, 113, 227, 0.1); border-radius: 3px;">
            </div>

            <div class="preview-container" style="display: none;">
                <div class="preview-box">
                    <h3>原始图片</h3>
                    <img id="originalPreview" class="preview-image">
                    <div id="originalInfo" class="file-info"></div>
                </div>
                <div class="preview-box">
                    <h3>压缩后</h3>
                    <img id="compressedPreview" class="preview-image">
                    <div id="compressedInfo" class="file-info"></div>
                    <button id="downloadButton" class="download-button">下载压缩后的图片</button>
                </div>
            </div>
        </div>

        <!-- 功能介绍区域移到下方 -->
        <section class="features-section">
            <h2 class="section-title">为什么选择我们的图片压缩工具？</h2>
            
            <!-- 智能压缩技术 -->
            <div class="feature-card">
                <div class="feature-content">
                    <div class="feature-icon-container">
                        <i class="ph ph-brain"></i>
                    </div>
                    <div class="feature-text">
                        <h3>智能压缩技术</h3>
                        <p>采用深度学习算法自动优化压缩参数，在保证画质的前提下最大程度减小文件体积。我们的AI模型经过数百万张图片训练，能够智能识别图片内容，自动选择最佳压缩策略。</p>
                    </div>
                </div>
            </div>

            <!-- 多格式支持 -->
            <div class="feature-card">
                <div class="feature-content">
                    <div class="feature-icon-container">
                        <i class="ph ph-file-image"></i>
                    </div>
                    <div class="feature-text">
                        <h3>多格式支持</h3>
                        <p>全面支持 JPG、PNG、WebP 等主流图片格式，满足不同场景的图片处理需求。自动识别最佳输出格式，确保最大程度的兼容性和压缩效果。</p>
                        <div class="format-tags" style="display: flex; gap: 8px;">
                            <span style="background: rgba(0,113,227,0.1); color: #0071e3; padding: 6px 12px; border-radius: 20px; font-size: 14px;">JPG</span>
                            <span style="background: rgba(0,113,227,0.1); color: #0071e3; padding: 6px 12px; border-radius: 20px; font-size: 14px;">PNG</span>
                            <span style="background: rgba(0,113,227,0.1); color: #0071e3; padding: 6px 12px; border-radius: 20px; font-size: 14px;">WebP</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 应用场景 -->
            <h2 class="section-title">图片压缩器的典型应用场景</h2>
            <div class="scenarios-grid">
                <div class="scenario-card">
                    <div class="scenario-icon">
                        <i class="ph ph-globe"></i>
                    </div>
                    <h3>网站性能优化</h3>
                    <p>通过压缩页面图片，显著提升网站加载速度，改善SEO排名和用户体验，让您的网站脱颖而出。</p>
                </div>
                <div class="scenario-card">
                    <div class="scenario-icon">
                        <i class="ph ph-device-mobile"></i>
                    </div>
                    <h3>移动端适配</h3>
                    <p>自动生成适合移动设备的优化图片，节省用户流量并提升应用性能，为用户带来流畅的移动体验。</p>
                </div>
            </div>

            <!-- 使用步骤 -->
            <h2 class="section-title">三步完成专业级压缩</h2>
            <div class="steps-grid">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-icon">
                        <i class="ph ph-upload-simple"></i>
                    </div>
                    <h3>上传图片</h3>
                    <p>拖放或点击选择需要压缩的图片文件，支持批量处理</p>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-icon">
                        <i class="ph ph-sliders"></i>
                    </div>
                    <h3>实时调整</h3>
                    <p>通过智能滑块精确控制压缩质量，实时预览效果</p>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-icon">
                        <i class="ph ph-download-simple"></i>
                    </div>
                    <h3>下载成果</h3>
                    <p>一键获取优化后的高质量图片文件，支持批量下载</p>
                </div>
            </div>
        </section>
    </div>

    <div class="image-comparison-modal" id="comparisonModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <div class="comparison-wrapper">
                <h3>原始图片</h3>
                <div class="comparison-image">
                    <img id="modalOriginal">
                </div>
                <div class="file-info" id="modalOriginalInfo"></div>
            </div>
            <div class="comparison-wrapper">
                <h3>压缩后</h3>
                <div class="comparison-image">
                    <img id="modalCompressed">
                </div>
                <div class="file-info" id="modalCompressedInfo"></div>
            </div>
        </div>
    </div>

    <div class="hover-preview" id="hoverPreview">
        <div class="hover-preview-content">
            <div class="hover-preview-side">
                <img class="hover-preview-image" id="hoverOriginal">
                <div class="hover-preview-info" id="hoverOriginalInfo"></div>
            </div>
            <div class="hover-preview-side">
                <img class="hover-preview-image" id="hoverCompressed">
                <div class="hover-preview-info" id="hoverCompressedInfo"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let filesToProcess = [];
        let processedFiles = [];
        const zip = new JSZip();

        // 新增拖拽事件处理
        const dragDropArea = document.getElementById('dragDropArea');
        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropArea.classList.add('dragover');
        });

        dragDropArea.addEventListener('dragleave', () => {
            dragDropArea.classList.remove('dragover');
        });

        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // 修改文件处理逻辑
        imageInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            filesToProcess = [...files].slice(0, 50);
            updateFileList();
            document.getElementById('batchControls').style.display = 'block';
            startProcessing();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = filesToProcess.map((file, index) => `
                <div class="file-item">
                    <div class="comparison-container">
                        <div class="comparison-side">
                            <h4>原图</h4>
                            <div class="preview-wrapper" 
                                 onmouseenter="showHoverPreview(${index}, event)" 
                                 onmousemove="updateHoverPosition(event)"
                                 onmouseleave="hideHoverPreview()">
                                <img class="preview-image" id="preview${index}_original" src="" alt="${file.name}">
                            </div>
                            <div class="size-info">${(file.size/1024).toFixed(1)}KB</div>
                        </div>
                        <div class="comparison-side">
                            <h4>压缩后</h4>
                            <div class="preview-wrapper"
                                 onmouseenter="showHoverPreview(${index}, event)"
                                 onmousemove="updateHoverPosition(event)"
                                 onmouseleave="hideHoverPreview()">
                                <img class="preview-image" id="preview${index}_compressed" src="" alt="${file.name}">
                            </div>
                            <div class="size-info" id="compressedSize${index}">处理中...</div>
                        </div>
                    </div>
                    <div class="file-info-wrapper">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 14px; word-break: break-all;">${file.name}</div>
                            <span id="status${index}" style="color:#0071e3">等待中</span>
                        </div>
                        <div id="compressionInfo${index}" class="size-info"></div>
                    </div>
                </div>
            `).join('');

            // 为每个文件生成原图预览
            filesToProcess.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(`preview${index}_original`).src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // 添加必要的DOM元素引用
        const qualitySlider = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');

        // 添加质量滑块事件监听
        qualitySlider.addEventListener('input', function() {
            qualityValue.textContent = this.value + '%';
            // 如果有正在处理的文件，重新开始处理
            if (filesToProcess.length > 0) {
                startProcessing();
            }
        });

        // 修改 startProcessing 函数，添加进度重置
        async function startProcessing() {
            processedFiles = [];
            const total = filesToProcess.length;
            
            // 重置进度条
            document.getElementById('batchProgress').style.width = '0%';
            document.getElementById('downloadAllBtn').disabled = true;
            
            for(let i = 0; i < total; i++) {
                const file = filesToProcess[i];
                const statusElement = document.getElementById(`status${i}`);
                statusElement.textContent = '处理中...';
                statusElement.style.color = '#0071e3';
                
                try {
                    const compressedFile = await processSingleFile(file);
                    processedFiles.push(compressedFile);
                    updateProgress(i+1, total);
                    statusElement.textContent = '完成';
                    statusElement.style.color = '#34c759';  // 成功后显示绿色
                } catch (error) {
                    statusElement.textContent = '失败';
                    statusElement.style.color = '#ff3b30';  // 失败后显示红色
                    console.error('处理文件失败:', file.name, error);
                }
            }
            
            document.getElementById('downloadAllBtn').disabled = false;
        }

        // 修改 processSingleFile 函数，更新压缩后的预览
        async function processSingleFile(file) {
            return new Promise((resolve, reject) => {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    reject(new Error('不支持的文件类型'));
                    return;
                }

                const reader = new FileReader();
                
                reader.onerror = () => reject(new Error('文件读取失败'));
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onerror = () => reject(new Error('图片加载失败'));
                    
                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            canvas.toBlob(blob => {
                                if (!blob) {
                                    reject(new Error('图片压缩失败'));
                                    return;
                                }
                                const compressedFile = new File([blob], `compressed_${file.name}`, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                
                                // 更新压缩后的预览和信息
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const index = filesToProcess.indexOf(file);
                                    if (index !== -1) {
                                        document.getElementById(`preview${index}_compressed`).src = e.target.result;
                                        document.getElementById(`compressedSize${index}`).textContent = 
                                            `${(compressedFile.size/1024).toFixed(1)}KB`;
                                        
                                        // 计算并显示压缩比
                                        const ratio = ((1 - compressedFile.size/file.size) * 100).toFixed(1);
                                        document.getElementById(`compressionInfo${index}`).innerHTML = 
                                            `压缩率: <span class="compression-ratio">-${ratio}%</span>`;
                                    }
                                };
                                reader.readAsDataURL(compressedFile);
                                
                                resolve(compressedFile);
                            }, 'image/jpeg', qualitySlider.value / 100);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            });
        }

        function updateProgress(current, total) {
            const progress = (current / total) * 100;
            document.getElementById('batchProgress').style.width = `${progress}%`;
            document.getElementById('downloadAllBtn').textContent = 
                `打包下载全部（${current}/${total}）`;
        }

        async function downloadAll() {
            const zip = new JSZip();
            processedFiles.forEach(file => {
                zip.file(file.name, file);
            });
            
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `compressed_images_${Date.now()}.zip`;
            link.click();
        }

        // 显示对比模态框
        function showComparison(index) {
            const modal = document.getElementById('comparisonModal');
            const originalFile = filesToProcess[index];
            const compressedFile = processedFiles[index];
            
            // 显示原始图片
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('modalOriginal').src = e.target.result;
                document.getElementById('modalOriginalInfo').textContent = 
                    `文件大小: ${(originalFile.size/1024).toFixed(1)}KB`;
            };
            reader.readAsDataURL(originalFile);

            // 显示压缩后的图片
            if (compressedFile) {
                const compressedReader = new FileReader();
                compressedReader.onload = (e) => {
                    document.getElementById('modalCompressed').src = e.target.result;
                    document.getElementById('modalCompressedInfo').textContent = 
                        `文件大小: ${(compressedFile.size/1024).toFixed(1)}KB`;
                };
                compressedReader.readAsDataURL(compressedFile);
            } else {
                document.getElementById('modalCompressed').src = '';
                document.getElementById('modalCompressedInfo').textContent = '处理中...';
            }

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }

        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('comparisonModal');
            modal.style.display = 'none';
            document.body.style.overflow = ''; // 恢复背景滚动
        }

        // 点击模态框背景关闭
        document.getElementById('comparisonModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // 添加悬浮预览相关函数
        const hoverPreview = document.getElementById('hoverPreview');
        let currentHoverTimeout;

        function showHoverPreview(index, event) {
            // 清除之前的延时器
            if (currentHoverTimeout) {
                clearTimeout(currentHoverTimeout);
            }

            // 添加小延迟，避免鼠标快速经过时频繁显示
            currentHoverTimeout = setTimeout(() => {
                const originalFile = filesToProcess[index];
                const compressedFile = processedFiles[index];

                // 获取原图和压缩后的图片URL
                const originalImg = document.getElementById(`preview${index}_original`);
                document.getElementById('hoverOriginal').src = originalImg.src;
                document.getElementById('hoverOriginalInfo').textContent = 
                    `原图大小: ${(originalFile.size/1024).toFixed(1)}KB`;

                const compressedImg = document.getElementById(`preview${index}_compressed`);
                if (compressedFile) {
                    document.getElementById('hoverCompressed').src = compressedImg.src;
                    document.getElementById('hoverCompressedInfo').textContent = 
                        `压缩后大小: ${(compressedFile.size/1024).toFixed(1)}KB`;
                }

                // 显示预览框
                hoverPreview.style.display = 'block';
                updateHoverPosition(event);
            }, 100); // 100ms延迟
        }

        function updateHoverPosition(event) {
            if (hoverPreview.style.display === 'none') return;

            const previewWidth = 800;
            const previewHeight = 400;
            const padding = 20;

            // 计算最佳显示位置
            let x = event.clientX + padding;
            let y = event.clientY + padding;

            // 确保预览框不会超出视窗
            if (x + previewWidth > window.innerWidth) {
                x = event.clientX - previewWidth - padding;
            }
            if (y + previewHeight > window.innerHeight) {
                y = event.clientY - previewHeight - padding;
            }

            // 确保不会显示在视窗外
            x = Math.max(padding, Math.min(x, window.innerWidth - previewWidth - padding));
            y = Math.max(padding, Math.min(y, window.innerHeight - previewHeight - padding));

            hoverPreview.style.left = `${x}px`;
            hoverPreview.style.top = `${y}px`;
        }

        function hideHoverPreview() {
            if (currentHoverTimeout) {
                clearTimeout(currentHoverTimeout);
            }
            hoverPreview.style.display = 'none';
        }

        // 添加窗口大小改变事件监听
        window.addEventListener('resize', () => {
            if (hoverPreview.style.display !== 'none') {
                hideHoverPreview();
            }
        });

        // 添加触摸反馈
        document.addEventListener('touchstart', function() {}, {passive: true});

        // 禁用双击缩放
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });

        // 添加下拉刷新功能
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, {passive: true});

        document.addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            const diff = touchY - touchStartY;
            if (diff > 50 && window.scrollY <= 0) {
                // 显示刷新提示
                if (!document.querySelector('.pull-to-refresh')) {
                    const refreshTip = document.createElement('div');
                    refreshTip.className = 'pull-to-refresh';
                    refreshTip.textContent = '下拉刷新';
                    document.body.prepend(refreshTip);
                }
            }
        }, {passive: true});

        document.addEventListener('touchend', (e) => {
            const refreshTip = document.querySelector('.pull-to-refresh');
            if (refreshTip) {
                refreshTip.remove();
            }
        }, {passive: true});
    </script>
</body>
</html>